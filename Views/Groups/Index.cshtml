@model List<MangoTaikaDistrict.Domain.Entities.Groupe>
@{
    ViewData["Title"] = "Groupes";
}

<!-- Hero Section -->
<section class="hero-section hero-scout section-scout position-relative overflow-hidden mb-5 natural-pattern">
    <div class="scout-leaf-decoration"></div>
    <div class="scout-leaf-decoration"></div>
    <div class="container position-relative" style="z-index: 2; padding-top: 80px; padding-bottom: 60px;">
        <div class="row align-items-center">
            <div class="col-lg-8 mx-auto text-center text-white">
                <h1 class="display-4 fw-bold mb-3 animate-fade-in">
                    <i class="bi bi-people me-2"></i>Nos Groupes
                </h1>
                <p class="lead mb-4 animate-slide-up">
                    Découvrez tous les groupes qui composent le district Mango Taika
                </p>
            </div>
        </div>
    </div>
</section>

<!-- Liste des Groupes -->
<div class="container mb-5">
    <div class="row g-4">
        @if (Model != null && Model.Any())
        {
            @foreach (var groupe in Model.Where(g => g.IsActive))
            {
                <div class="col-md-6 col-lg-4">
                    <div class="card-scout card-modern h-100 animate-fade-in">
                        <div class="card-badge">
                            <i class="bi bi-building"></i>
                        </div>
                        <div class="card-body">
                            <h4 class="fw-bold mb-3 text-primary">
                                <i class="bi bi-people me-2"></i>@groupe.Nom
                            </h4>
                            
                            @if (!string.IsNullOrEmpty(groupe.Adresse))
                            {
                                <p class="text-muted mb-2">
                                    <i class="bi bi-geo-alt me-2"></i>@groupe.Adresse
                                </p>
                            }
                            
                            @if (!string.IsNullOrEmpty(groupe.ContactTel))
                            {
                                <p class="text-muted mb-2">
                                    <i class="bi bi-telephone me-2"></i>
                                    <a href="tel:@groupe.ContactTel" class="text-decoration-none">@groupe.ContactTel</a>
                                </p>
                            }
                            
                            @if (!string.IsNullOrEmpty(groupe.ContactEmail))
                            {
                                <p class="text-muted mb-3">
                                    <i class="bi bi-envelope me-2"></i>
                                    <a href="mailto:@groupe.ContactEmail" class="text-decoration-none">@groupe.ContactEmail</a>
                                </p>
                            }
                            
                            @if (groupe.GpsLat.HasValue && groupe.GpsLng.HasValue)
                            {
                                <div class="d-grid gap-2 mt-3">
                                    <a href="https://www.google.com/maps?q=@groupe.GpsLat,@groupe.GpsLng" 
                                       target="_blank" 
                                       class="btn btn-scout btn-sm">
                                        <i class="bi bi-geo-alt me-2"></i>Voir sur la carte
                                    </a>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12">
                <div class="card-modern card-scout text-center p-5">
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="bi bi-inbox" style="font-size: 4rem; color: var(--color-primary-soft);"></i>
                        </div>
                        <h3 class="empty-state-title">Aucun groupe disponible</h3>
                        <p class="empty-state-text">Les groupes seront bientôt disponibles.</p>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<!-- Carte Interactive -->
@if (Model != null && Model.Any(g => g.GpsLat.HasValue && g.GpsLng.HasValue))
{
    <div class="container mb-5">
        <div class="card-scout card-modern">
            <div class="card-body p-4">
                <h3 class="fw-bold mb-4">
                    <i class="bi bi-map me-2 text-primary"></i>Carte Interactive
                </h3>
                <div id="map" style="height: 500px; border-radius: var(--radius-lg); overflow: hidden; border: 2px solid var(--color-border);"></div>
            </div>
        </div>
    </div>
}

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
      crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
        crossorigin=""></script>

<script>
    @if (Model != null && Model.Any(g => g.GpsLat.HasValue && g.GpsLng.HasValue))
    {
        <text>
        // Initialiser la carte centrée sur Abidjan
        const map = L.map('map').setView([5.345, -4.024], 11);
        
        // Ajouter les tuiles OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Données des groupes avec coordonnées GPS
        const groups = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
            Model.Where(x => x.GpsLat.HasValue && x.GpsLng.HasValue && x.IsActive)
                 .Select(x => new { 
                     x.Nom, 
                     x.Adresse,
                     lat = x.GpsLat, 
                     lng = x.GpsLng, 
                     x.ContactTel,
                     x.ContactEmail
                 })
        ));
        
        // Ajouter les marqueurs pour chaque groupe
        groups.forEach(g => {
            const popupContent = `
                <div style="min-width: 200px;">
                    <h5 class="fw-bold mb-2" style="color: var(--color-primary);">${g.Nom}</h5>
                    ${g.Adresse ? `<p class="mb-1"><i class="bi bi-geo-alt"></i> ${g.Adresse}</p>` : ''}
                    ${g.ContactTel ? `<p class="mb-1"><i class="bi bi-telephone"></i> <a href="tel:${g.ContactTel}">${g.ContactTel}</a></p>` : ''}
                    ${g.ContactEmail ? `<p class="mb-0"><i class="bi bi-envelope"></i> <a href="mailto:${g.ContactEmail}">${g.ContactEmail}</a></p>` : ''}
                </div>
            `;
            
            // Créer un marqueur personnalisé avec couleur verte
            const greenIcon = L.icon({
                iconUrl: 'data:image/svg+xml;base64,' + btoa(`
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
                        <circle cx="16" cy="16" r="12" fill="#2D5016" stroke="white" stroke-width="2"/>
                        <circle cx="16" cy="16" r="6" fill="white"/>
                    </svg>
                `),
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });
            
            L.marker([g.lat, g.lng], { icon: greenIcon })
                .addTo(map)
                .bindPopup(popupContent);
        });
        </text>
    }
</script>

<style>
    .leaflet-popup-content-wrapper {
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-lg);
    }
    
    .leaflet-popup-content {
        margin: 1rem;
    }
    
    .leaflet-popup-content a {
        color: var(--color-primary);
        text-decoration: none;
        font-weight: 500;
    }
    
    .leaflet-popup-content a:hover {
        color: var(--color-primary-light);
        text-decoration: underline;
    }
</style>
